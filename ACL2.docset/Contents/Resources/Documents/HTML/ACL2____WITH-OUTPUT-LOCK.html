<html>
<head>
<meta charset="UTF-8">
<title>With-output-lock</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____WITH-OUTPUT-LOCK">Click for With-output-lock in the Full Manual</a></h3>

<p>Provides a mutual-exclusion mechanism for performing output in parallel</p><p>This documentation topic relates to an experimental extension of 
 ACL2, ACL2(p), created initially by David L. Rager.  See <a href="ACL2____COMPILING-ACL2P.html">compiling-ACL2p</a> for how to build an executable image that supports parallel 
 execution.  Also see community books directory <span class="v">books/parallel/</span> for 
 examples.</p> 
 
 <p>One may wish to perform output while executing code in parallel.  If 
 threads are allowed to print concurrently, the output will be interleaved and 
 often unreadable.  To avoid this, the user can surround forms that perform 
 output with the <span class="v">with-output-lock</span> macro.  Warning: <span class="v">with-output-lock</span> 
 may not perform as expected when called directly in the loop; see <a href="ACL2____PARALLELISM-AT-THE-TOP-LEVEL.html">parallelism-at-the-top-level</a>.</p> 
 
 <p>Take the following definition of <span class="v">pfib</span> as an example.</p> 
 
 <pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a> pfib (x)
  (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :guard (<a href="ACL2____NATP.html">natp</a> x)))
  (<a href="COMMON-LISP____COND.html">cond</a> ((<a href="ACL2____MBE.html">mbe</a> :logic (<a href="COMMON-LISP____OR.html">or</a> (<a href="ACL2____ZP.html">zp</a> x) (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> x 0))
              :exec (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> x 0))
         0)
        ((<a href="COMMON-LISP_____D3.html">=</a> x 1) 1)
        (t (<a href="ACL2____PLET.html">plet</a> (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____GRANULARITY.html">granularity</a> t))
                 ((a (<a href="ACL2____PROG2_42.html">prog2$</a> (<a href="ACL2____CW.html">cw</a> "Computing pfib ~x0~%" (<a href="COMMON-LISP____-.html">-</a> x 1))
                             (pfib (<a href="COMMON-LISP____-.html">-</a> x 1))))
                  (b (<a href="ACL2____PROG2_42.html">prog2$</a> (<a href="ACL2____CW.html">cw</a> "Computing pfib ~x0~%" (<a href="COMMON-LISP____-.html">-</a> x 2))
                             (pfib (<a href="COMMON-LISP____-.html">-</a> x 2)))))
                 (<a href="COMMON-LISP_____B2.html">+</a> a b)))))</pre> 
 
 <p>With <a href="ACL2____PARALLEL-EXECUTION.html">parallel-execution</a> enabled, a call of <span class="v">(pfib 5)</span>results in 
 non-deterministically interleaved output, for example as follows.</p> 
 
 <pre class="code">ACL2 !&gt;(pfib 5)
CComputing pfib 4
omputing pfib 3
ComCpuotmipnugt ipnfgi bp fib3
2
Computing pCfiobm put2i
ng pfib 1
Computing pfib Co1mp
uting pfib 0
CCoommppuuttiinngg  ppffiibb  12

ComCpuotmipnugt ipnfgi bp fib1
0
CoCmopmuptuitnign gp fpifbi b 1
0
5
ACL2 !&gt;</pre> 
 
 <p>If the user instead surrounds the calls to <span class="tt"><a href="ACL2____CW.html">cw</a></span> with the macro 
 <span class="v">with-output-lock</span>, as in the following session, the output will no longer 
 be interleaved.</p> 
 
 <pre class="code">ACL2 !&gt;
(<a href="COMMON-LISP____DEFUN.html">defun</a> pfib (x)
  (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :guard (<a href="ACL2____NATP.html">natp</a> x)))
  (<a href="COMMON-LISP____COND.html">cond</a> ((<a href="ACL2____MBE.html">mbe</a> :logic (<a href="COMMON-LISP____OR.html">or</a> (<a href="ACL2____ZP.html">zp</a> x) (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> x 0))
              :exec (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> x 0))
         0)
        ((<a href="COMMON-LISP_____D3.html">=</a> x 1) 1)
        (t (<a href="ACL2____PLET.html">plet</a> (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____GRANULARITY.html">granularity</a> t))
                 ((a (<a href="ACL2____PROG2_42.html">prog2$</a> (<a href="ACL2____WITH-OUTPUT-LOCK.html">with-output-lock</a>
                              (<a href="ACL2____CW.html">cw</a> "Computing pfib ~x0~%" (<a href="COMMON-LISP____-.html">-</a> x 1)))
                             (pfib (<a href="COMMON-LISP____-.html">-</a> x 1))))
                  (b (<a href="ACL2____PROG2_42.html">prog2$</a> (<a href="ACL2____WITH-OUTPUT-LOCK.html">with-output-lock</a>
                              (<a href="ACL2____CW.html">cw</a> "Computing pfib ~x0~%" (<a href="COMMON-LISP____-.html">-</a> x 2)))
                             (pfib (<a href="COMMON-LISP____-.html">-</a> x 2)))))
                 (<a href="COMMON-LISP_____B2.html">+</a> a b)))))

&lt;snip&gt;

ACL2 !&gt;(pfib 5)
Computing pfib 4
Computing pfib 3
Computing pfib 3
Computing pfib 2
Computing pfib 2
Computing pfib 1
Computing pfib 2
Computing pfib 1
Computing pfib 1
Computing pfib 0
Computing pfib 1
Computing pfib 0
Computing pfib 1
Computing pfib 0
5
ACL2 !&gt;</pre>
</body>
</html>
