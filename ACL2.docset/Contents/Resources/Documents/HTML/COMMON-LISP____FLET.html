<html>
<head>
<meta charset="UTF-8">
<title>Flet</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=COMMON-LISP____FLET">Click for Flet in the Full Manual</a></h3>

<p>Local binding of function symbols</p><pre class="code">Example Form:
; The following evaluates to (<a href="ACL2____MV.html">mv</a> 7 10):
(<a href="COMMON-LISP____FLET.html">flet</a> ((f (x)
          (<a href="COMMON-LISP_____B2.html">+</a> x 3))
       (<a href="ACL2____G.html">g</a> (x)
          (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="COMMON-LISP____TYPE.html">type</a> integer x))
          (<a href="COMMON-LISP_____A2.html">*</a> x 2)))
  (<a href="ACL2____MV.html">mv</a> (f 4) (<a href="ACL2____G.html">g</a> 5)))

General Forms:
(<a href="COMMON-LISP____FLET.html">flet</a> (def1 ... defk) body)
(<a href="COMMON-LISP____FLET.html">flet</a> (def1 ... defk) declare-form1 .. declare-formk body)</pre> 
 
 <p>where <span class="v">body</span> is a term, and each <span class="v">defi</span> is a definition as in <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span> but with the leading <span class="v">defun</span> symbol omitted.  See <a href="COMMON-LISP____DEFUN.html">defun</a>, but 
 see <a href="COMMON-LISP____DECLARE.html">declare</a> for the declarations permitted directly under the 
 <span class="v">defi</span>.  On the other hand, regarding the <span class="v">declare-formi</span> (if any are 
 supplied): each must be of the form <span class="v">(<a href="COMMON-LISP____DECLARE.html">declare</a> decl1 ... decln)</span>, where each 
 <span class="v">decli</span> is of the form <span class="v">(<a href="COMMON-LISP____INLINE.html">inline</a> g1 ... gm)</span> or <span class="v">(notinline g1
 ... gm)</span>, and each <span class="v">gi</span> is defined by some <span class="v">defi</span>.</p> 
 
 <p>The only effect of the declarations is to provide advice to the host Lisp 
 compiler.  The declarations are otherwise ignored by ACL2, so we mainly ignore 
 them in the discussion below.</p> 
 
 <p>The innermost <span class="v">flet</span>-binding of a function symbol, <span class="v">f</span>, above a call 
 of <span class="v">f</span>, is the one that provides the definition of <span class="v">f</span> for that call. 
 Note that <span class="v">flet</span> does not provide recursion.  Consider the following 
 example.</p> 
 
 <pre class="code">; Give a global definition of f:
(<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) (<a href="COMMON-LISP_____B2.html">+</a> x 3))
; Evaluate an expression using a local binding of f:
(<a href="COMMON-LISP____FLET.html">flet</a> ((f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x (f (<a href="COMMON-LISP____1_B2.html">1+</a> x)))))
  (f 4))</pre> 
 
 <p>In the above term <span class="v">(<a href="COMMON-LISP____CONS.html">cons</a> x (f (<a href="COMMON-LISP____1_B2.html">1+</a> x)))</span>, <span class="v">f</span> refers to the global 
 definition of <span class="v">f</span> above the <span class="v">flet</span> expression.  However, <span class="v">(f 4)</span> 
 refers to the <span class="v">flet</span>-binding of <span class="v">f</span>, <span class="v">(f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x (f x)))</span>.  The 
 result of the <span class="v">flet</span> expression is thus obtained by evaluating <span class="v">(f 4)</span> 
 where <span class="v">(f 4)</span> is <span class="v">(<a href="COMMON-LISP____CONS.html">cons</a> 4 (f (<a href="COMMON-LISP____1_B2.html">1+</a> 4)))</span>, where the latter call of <span class="v">f</span> 
 refers to the global definition; thus we have <span class="v">(<a href="COMMON-LISP____CONS.html">cons</a> 4 (f 5))</span>, which 
 evaluates to <span class="v">(4 . 8)</span>.</p> 
 
 <p>Although <span class="v">flet</span> behaves in ACL2 essentially as it does in Common Lisp, 
 ACL2 imposes the following restrictions and qualifications.</p> 
 
 <ul> 
 
 <li>Every <span class="tt"><a href="COMMON-LISP____DECLARE.html">declare</a></span> form for a local definition (<span class="v">def1</span> 
 through <span class="v">defk</span>, above) must be an <span class="v">ignore</span>, <span class="v">ignorable</span>, or <span class="v">type</span> 
 expression.</li> 
 
 <li>Each <span class="v">defi</span> must bind a different function symbol.</li> 
 
 <li>Each <span class="v">defi</span> must bind a symbol that is a legal name for an ACL2 
 function symbol.  In particular, the symbol may not be in the keyword package 
 or the main Lisp package.  Moreover, the symbol may not be a built-in ACL2 
 function or macro.</li> 
 
 <li>Every variable occurring in the body of a <span class="v">defi</span> must be a formal 
 parameter of that <span class="v">defi</span>.  (This restriction is not enforced in Common 
 Lisp.)</li> 
 
 <li>If the <span class="v">flet</span>-binding <span class="v">defi</span> is in the body of a function <span class="v">f</span>, 
 then the <a href="ACL2____STOBJ.html">stobj</a> inputs for <span class="v">defi</span> are implicitly those of its inputs 
 that are declared <a href="ACL2____STOBJ.html">stobj</a> inputs of <span class="v">f</span>.</li> 
 
 </ul> 
 
 <p><span class="v">Flet</span> bindings are evaluated in parallel.  Consider the following 
 example.</p> 
 
 <pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) x)
(<a href="COMMON-LISP____FLET.html">flet</a> ((f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x x))
       (<a href="ACL2____G.html">g</a> (x) (f x)))
  (<a href="ACL2____G.html">g</a> 3))</pre> 
 
 <p>The binding of <span class="v">g</span> refers to the global value of <span class="v">f</span>, not the 
 <span class="v">flet</span>-binding of <span class="v">f</span>.  Thus, the <span class="v">flet</span> expression evaluates to 3. 
 Compare the <span class="v">flet</span> expression above to the following one, which instead 
 evaluates to <span class="v">(3 . 3)</span>.</p> 
 
 <pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) x)
(<a href="COMMON-LISP____FLET.html">flet</a> ((f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x x)))
  (<a href="COMMON-LISP____FLET.html">flet</a> ((<a href="ACL2____G.html">g</a> (x) (f x)))
    (<a href="ACL2____G.html">g</a> 3)))</pre> 
 
 <p>Under the hood, ACL2 translates <span class="v">flet</span> bindings to <span class="tt"><a href="COMMON-LISP____LAMBDA.html">lambda</a></span> 
 expressions (see <a href="ACL2____TERM.html">term</a>), throwing away the <span class="v">inline</span> and 
 <span class="v">notinline</span> declarations (if any).  The following example illustrates this 
 point.</p> 
 
 <pre class="code">ACL2 !&gt;:trans (<a href="COMMON-LISP____FLET.html">flet</a> ((f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x x))
                     (<a href="ACL2____G.html">g</a> (x y) (<a href="COMMON-LISP_____B2.html">+</a> x y)))
                (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="COMMON-LISP____INLINE.html">inline</a> f))
                (f (<a href="ACL2____G.html">g</a> 3 4)))

((<a href="COMMON-LISP____LAMBDA.html">LAMBDA</a> (X) (<a href="COMMON-LISP____CONS.html">CONS</a> X X))
 ((<a href="COMMON-LISP____LAMBDA.html">LAMBDA</a> (X Y) (<a href="ACL2____BINARY-_B2.html">BINARY-+</a> X Y)) '3 '4))

=&gt; *

ACL2 !&gt;</pre> 
 
 <p><span class="v">Flet</span> is part of Common Lisp.  See any Common Lisp documentation for 
 more information.  We conclude by pointing out an important aspect of 
 <span class="v">flet</span> shared by ACL2 and Common Lisp: The binding is lexical, not dynamic. 
 That is, the <span class="v">flet</span> binding of a function symbol only applies to calls of 
 that function symbol in the body of the <span class="v">flet</span>, not other calls made in the 
 course of evaluation.  Consider the following example.  Suppose we define:</p> 
 
 <pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) x)
(<a href="COMMON-LISP____DEFUN.html">defun</a> g (x) (f x))
(<a href="COMMON-LISP____DEFUN.html">defun</a> h (x)
  (<a href="COMMON-LISP____FLET.html">flet</a> ((f (x) (<a href="COMMON-LISP____CONS.html">cons</a> x x)))
    (<a href="ACL2____G.html">g</a> x)))</pre> 
 
 <p>Then evaluation of <span class="v">(h 3)</span> results in <span class="v">3</span>, not in the <span class="v">cons</span> pair 
 <span class="v">(3 . 3)</span>, because the <span class="v">flet</span> binding of <span class="v">f</span> only applies to calls of 
 <span class="v">f</span> that appear in the body of that <span class="v">flet</span>.  In this case, only <span class="v">g</span> 
 is called in the body of that <span class="v">flet</span>.</p>
</body>
</html>
