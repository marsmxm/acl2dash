<html>
<head>
<meta charset="UTF-8">
<title>Ld-error-action</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____LD-ERROR-ACTION">Click for Ld-error-action in the Full Manual</a></h3>

<p>Determines <span class="tt"><a href="ACL2____LD.html">ld</a></span>'s response to an error</p><p><span class="v">Ld-error-action</span> is an <span class="tt"><a href="ACL2____LD.html">ld</a></span> special (see <a href="ACL2____LD.html">ld</a>).  The 
 accessor is <span class="v">(<a href="ACL2____LD-ERROR-ACTION.html">ld-error-action</a> state)</span> and the updater is 
 <span class="v">(set-ld-error-action val state)</span>.  <span class="v">Ld-error-action</span> must be 
 <span class="v">:continue</span>, <span class="v">:return</span>, <span class="v">:return!</span>, <span class="v">:error</span>, or <span class="v">(:exit N)</span> 
 for some natural number <span class="v">N</span>.  The initial value of <span class="v">ld-error-action</span> is 
 <span class="v">:continue</span>, which means that the top-level ACL2 <a href="ACL2____COMMAND.html">command</a> loop (see 
 <span class="tt"><a href="ACL2____LP.html">lp</a></span>) will not exit when an error is caused by <span class="v">user-typein</span>.  But 
 the default value for <span class="v">ld-error-action</span> on calls of <span class="tt"><a href="ACL2____LD.html">ld</a></span> is 
 <span class="v">:return!</span>, with one exception: in the case that the value of <span class="tt"><a href="ACL2____LD.html">ld</a></span> 
 special <span class="v">ld-error-action</span> is <span class="v">(:exit N)</span>, the default remains that 
 value.</p> 
 
 <p>The general-purpose ACL2 read-eval-print loop, <span class="tt"><a href="ACL2____LD.html">ld</a></span>, reads forms from 
 <span class="tt"><a href="ACL2____STANDARD-OI.html">standard-oi</a></span>, evaluates them and prints the result to <span class="tt"><a href="ACL2____STANDARD-CO.html">standard-co</a></span>.  Note that the ACL2 top-level loop (see <span class="tt"><a href="ACL2____LP.html">lp</a></span>) results from 
 an invocation of <span class="tt"><a href="ACL2____LD.html">ld</a></span>.</p> 
 
 <p>However, there are various flags that control <span class="tt"><a href="ACL2____LD.html">ld</a></span>'s behavior and 
 <span class="v">ld-error-action</span> is one of them.  Suppose that <span class="tt"><a href="ACL2____LD-ERROR-TRIPLES.html">ld-error-triples</a></span> is 
 <span class="v">t</span> and a form evaluates to an <a href="ACL2____ERROR-TRIPLE.html">error-triple</a> <span class="v">(<a href="ACL2____MV.html">mv</a> erp val state)</span>. 
 If the ``error component'', <span class="v">erp</span>, is non-<span class="v">nil</span>, then an error is said 
 to have occurred.  If an error occurs, <span class="tt"><a href="ACL2____LD.html">ld</a></span>'s action depends on 
 <span class="v">ld-error-action</span>.  If it is <span class="v">:continue</span>, <span class="tt"><a href="ACL2____LD.html">ld</a></span> just continues 
 processing the forms in <span class="tt"><a href="ACL2____STANDARD-OI.html">standard-oi</a></span>.  If it is <span class="v">:return</span> or 
 <span class="v">:return!</span>, <span class="tt"><a href="ACL2____LD.html">ld</a></span> stops and returns as though it had emptied the 
 channel.  If it is <span class="v">:error</span>, <span class="tt"><a href="ACL2____LD.html">ld</a></span> stops and returns, signaling an 
 error to its caller by returning an error triple with non-<span class="v">nil</span> error 
 component, and reverting the logical <a href="ACL2____WORLD.html">world</a> to its value just before 
 that call of <span class="tt"><a href="ACL2____LD.html">ld</a></span>.  If it is <span class="v">(:exit N)</span>, then ACL2 quits with exit 
 status <span class="v">N</span>.</p> 
 
 <p>To see this effect of <span class="v">:ERROR</span> for <span class="v">ld-error-action</span>, consider the 
 following example.</p> 
 
 <pre class="code">(<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) x) (<a href="COMMON-LISP____DEFUN.html">defun</a> bad (x)) (<a href="COMMON-LISP____DEFUN.html">defun</a> g (x) x)))</pre> 
 
 <p>When the <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span> of <span class="v">bad</span> fails (because its body is missing), 
 evaluation of the <span class="v">ld</span> call stops; thus, the <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span> of <span class="v">g</span> is not 
 evaluated.  The definition of <span class="v">f</span> will be removed from the logical <a href="ACL2____WORLD.html">world</a> before the call of <span class="v">ld</span> returns.</p> 
 
 <p>However, by default each user call of <span class="v">ld</span> is made with a 
 <span class="v">ld-error-action</span> of <span class="v">:RETURN!</span> (not <span class="v">:ERROR</span>).  In the common case 
 that all nested calls of <span class="v">ld</span> inside the ACL2 loop are made this way, an 
 error will not roll back the logical <a href="ACL2____WORLD.html">world</a>.  However, it will still 
 halt evaluation of forms for the current call of <span class="v">ld</span> and any parent calls 
 of <span class="v">ld</span> (other than the call made on behalf of <span class="v">lp</span> that entered the 
 ACL2 loop in the first place), as though there were no more forms to 
 evaluate.</p> 
 
 <p>We have already discussed the behavior of <span class="v">ld</span> when an error occurs. 
 But there is another case when <span class="v">ld</span> can stop processing more forms: when 
 <span class="v">ld-error-action</span> is not <span class="v">:CONTINUE</span>, <span class="tt"><a href="ACL2____LD-ERROR-TRIPLES.html">ld-error-triples</a></span> is 
 <span class="v">t</span>, and evaluation of a form returns an error triple <span class="v">(<a href="ACL2____MV.html">mv</a> nil val
 state)</span>, where <span class="v">nil</span> is the error component and whose ``value component'', 
 <span class="v">val</span> is a <span class="tt"><a href="COMMON-LISP____CONS.html">cons</a></span> pair whose <span class="tt"><a href="COMMON-LISP____CAR.html">car</a></span> is the symbol <span class="v">:STOP-LD</span>. 
 Let <span class="v">val</span> be the pair <span class="v">(:STOP-LD . x)</span>.  Then the call of <span class="v">ld</span> 
 returns the error triple <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD n . x) state)</span>, where <span class="v">n</span> is 
 the value of <span class="tt"><a href="ACL2____STATE.html">state</a></span> global variable <span class="v">'ld-level</span> at the time of 
 termination.  The following example illustrates how this works.</p> 
 
 <pre class="code">(<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f1 (x) x)
      (<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f2 (x) x)
            (<a href="ACL2____MV.html">mv</a> nil '(:STOP-LD my-error more-info) state)
            (<a href="COMMON-LISP____DEFUN.html">defun</a> g2 (x) x)))
      (<a href="COMMON-LISP____DEFUN.html">defun</a> g1 (x) x)))</pre> 
 
 <p>The outer call of <span class="v">ld</span> returns the value</p> 
 
 <pre class="code">(:STOP-LD 2 3 MY-ERROR MORE-INFO)</pre> 
 
 <p>and leaves us in a world the includes definitions for <span class="v">f1</span> and <span class="v">f2</span>, 
 but no definition for <span class="v">g1</span> or <span class="v">g2</span> since neither of their two <span class="v">defun</span> 
 forms was evaluated.  The value of <span class="tt"><a href="ACL2____STATE.html">state</a></span> global <span class="v">'ld-level</span> is 
 incremented from 1 to 2 when the outer <span class="v">ld</span> is entered and then again to 3 
 when the inner <span class="v">ld</span> is entered.  When the inner <span class="v">ld</span> encounters the 
 error triple <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD my-error more-info) state)</span>, it sees 
 <span class="v">:STOP-LD</span> in the <span class="v">car</span> of the value component and pushes the current 
 value of <span class="v">'ld-level</span>, 3, onto the <span class="tt"><a href="COMMON-LISP____CDR.html">cdr</a></span> of that value, to return the 
 value triple <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD my-error 3 more-info) state)</span>.  The outer 
 of <span class="v">ld</span> then sees this value and returns <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD my-error 2 3
 more-info) state)</span>, since its current value of <span class="v">'ld-level</span> is 2 after the 
 inner <span class="v">ld</span> exits.</p> 
 
 <p>That concludes our discussion of how these special <span class="v">:STOP-LD</span> values are 
 handled; but how are they created?  While they can be created directly by 
 evaluation results as suggested in the example above, that is not the standard 
 way.  Rather, <span class="v">ld</span> returns an error triple <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD n)
 state)</span>, where <span class="v">n</span> is the value of variable <span class="v">ld-level</span> at the time of 
 termination, when the following conditions hold: an error occurs, 
 <span class="v">ld-error-action</span> is <span class="v">RETURN!</span> (which is the default), and <span class="tt"><a href="ACL2____LD-ERROR-TRIPLES.html">ld-error-triples</a></span> is <span class="v">t</span> (the default).  The following example, which is a 
 bit similar to the preceding one, illustrates both creation and handling of 
 the special <span class="v">:STOP-LD</span> values.</p> 
 
 <pre class="code">(<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f1 (x) x)
      (<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f2 (x) x)
            (<a href="ACL2____LD.html">ld</a> '((<a href="COMMON-LISP____DEFUN.html">defun</a> f3 (x) x)
                  (<a href="COMMON-LISP____DEFUN.html">defun</a> bad (x)) ; ERROR -- missing the body
                  (<a href="COMMON-LISP____DEFUN.html">defun</a> g3 (x) x)))
            (<a href="COMMON-LISP____DEFUN.html">defun</a> g2 (x) x)))
      (<a href="COMMON-LISP____DEFUN.html">defun</a> g1 (x) x)))</pre> 
 
 <p>The result is that <span class="v">f1</span>, <span class="v">f2</span>, and <span class="v">f3</span> are defined, but none of 
 <span class="v">g1</span>, <span class="v">g2</span>, or <span class="v">g3</span> is defined.  Let's see why.  The innermost call 
 of <span class="tt"><a href="ACL2____LD.html">ld</a></span> has a default <span class="v">:ld-error-action</span> of <span class="v">:RETURN!</span> (as do the 
 other calls).  So when the definition of <span class="v">bad</span> fails, then the innermost 
 <span class="v">ld</span> returns <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD 4) state)</span>.  The middle <span class="v">ld</span> sees 
 this value, and since its <span class="v">:ld-error-action</span> is not <span class="v">:CONTINUE</span> (because 
 it has the default value of <span class="v">:RETURN!</span>), it returns before considering the 
 definition of <span class="v">g2</span>, with value <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD 3 4) state)</span>.  The 
 topmost call of <span class="v">ld</span> similarly sees the <span class="v">:STOP-LD</span>; stops evaluation of 
 forms, without defining <span class="v">g1</span>; and returns <span class="v">(<a href="ACL2____MV.html">mv</a> nil (:STOP-LD 2 3 4)
 state)</span>.</p>
</body>
</html>
