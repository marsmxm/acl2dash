<html>
<head>
<meta charset="UTF-8">
<title>Defprojection</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=STD____DEFPROJECTION">Click for Defprojection in the Full Manual</a></h3>

<p>Project a transformation across a list.</p><p>Defprojection allows you to quickly introduce a function like 
<span class="v">map f</span>.  That is, given an element-transforming function, <span class="v">f</span>, it can 
define a new function that applies <span class="v">f</span> to every element in a list.  It also 
sets up a basic theory with rules about <a href="ACL2____LEN.html">len</a>, <a href="COMMON-LISP____APPEND.html">append</a>, etc., and 
generates basic, automatic <a href="ACL2____XDOC.html">xdoc</a> documentation.</p> 
 
<h4>General form:</h4> 
 
<pre class="code">(<a href="STD____DEFPROJECTION.html">defprojection</a> name extended-formals
  element
  [keyword options]
  [/// other events]
  )

Options                 Defaults
 :nil-preservingp         nil
 :guard                   t
 :verify-guards           t
 :result-type             nil
 :returns                 nil
 :mode                    current defun-mode
 :already-definedp        nil
 :parallelize             nil
 :verbosep                nil
 :share-suffix            nil
 :parents                 nil
 :short                   nil
 :long                    nil</pre> 
 
<h4>Basic Examples</h4> 
 
<pre class="code">(<a href="STD____DEFPROJECTION.html">defprojection</a> my-strip-cars (x)
  (<a href="COMMON-LISP____CAR.html">car</a> x)
  :guard (<a href="ACL2____ALISTP.html">alistp</a> x))</pre> 
 
<p>defines a new function, <span class="v">my-strip-cars</span>, that is like the built-in ACL2 
function <a href="ACL2____STRIP-CARS.html">strip-cars</a>.</p> 
 
<p><b><font color="#ff0000">Note</font></b>: <span class="v">x</span> is treated in a special 
way.  It refers to the whole list in the formals and guards, but refers to 
individual elements of the list in the <span class="v">element</span> portion.  This is similar 
to how other macros like <a href="STD____DEFLIST.html">deflist</a>, <a href="STD____DEFALIST.html">defalist</a>, and <a href="STD____DEFMAPAPPEND.html">defmapappend</a> handle <span class="v">x</span>.</p> 
 
<p>A <a href="ACL2____DEFINE.html">define</a>-like syntax is also available:</p> 
 
<pre class="code">(<a href="STD____DEFPROJECTION.html">defprojection</a> my-square-list ((x integer-listp))
  :result (squared-x integer-listp)
  (<a href="COMMON-LISP_____A2.html">*</a> x x))</pre> 
 
<h3>Usage and Optional Arguments</h3> 
 
<p>Let <span class="v">pkg</span> be the package of <span class="v">name</span>.  All functions, theorems, and 
variables are created in this package.  One of the formals must be <span class="v">pkg::x</span>, 
and this argument represents the list that will be transformed.  Otherwise, the 
only restriction on formals is that you may not use the names <span class="v">pkg::a</span>, 
<span class="v">pkg::n</span>, <span class="v">pkg::y</span>, and <span class="v">pkg::acc</span>, because we use these variables in 
the theorems we generate.</p> 
 
<p>The optional <span class="v">:nil-preservingp</span> argument can be set to <span class="v">t</span> when the 
element transformation satisfies <span class="v">(element nil ...) = nil</span>.  This allows 
<span class="v">defprojection</span> to produce slightly better theorems.</p> 
 
<p>The optional <span class="v">:guard</span> and <span class="v">:verify-guards</span> are given to the 
<span class="v">defund</span> event that we introduce.  Often <a href="STD____DEFLIST.html">deflist</a> is convenient for 
introducing the necessary guard.</p> 
 
<p>The optional <span class="v">:result-type</span> keyword defaults to <span class="v">nil</span>, and in this 
case no additional "type theorem" will be inferred.  But, if you instead give 
the name of a unary predicate like <span class="v">nat-listp</span>, then a defthm will be 
generated that looks like <span class="v">(<a href="ACL2____IMPLIES.html">implies</a> (<a href="ACL2____FORCE.html">force</a> guard) (<a href="ACL2____NAT-LISTP.html">nat-listp</a> (name ...)))</span> 
while <span class="v">name</span> is still enabled.  This is not a very general mechanism, but it 
is often good enough to save a lot of typing.</p> 
 
<p>The optional <span class="v">:returns</span> keyword is similar to that of <a href="ACL2____DEFINE.html">define</a>, and 
is a more general mechanism than <span class="v">:result-type</span>.</p> 
 
<p>The optional <span class="v">:already-definedp</span> keyword can be set if you have already 
defined the function.  This can be used to generate all of the ordinary 
<span class="v">defprojection</span> theorems without generating a <span class="v">defund</span> event, and is 
useful when you are dealing with mutually recursive transformations.</p> 
 
<p>The optional <span class="v">:mode</span> keyword can be set to <span class="v">:logic</span> or <span class="v">:program</span> 
to introduce the recognizer in logic or program mode.  The default is whatever 
the current default defun-mode is for ACL2, i.e., if you are already in program 
mode, it will default to program mode, etc.</p> 
 
<p>The optional <span class="v">:parallelize</span> keyword can be set to <span class="v">t</span> if you want to 
try to speed up the execution of new function using parallelism.  This is 
experimental and only works with ACL2(p).  Note: we don't do anything smart to 
split the work up into large chunks, and you lose tail-recursion when you use 
this.</p> 
 
<p>The optional <span class="v">:share-suffix</span> keyword can be set to <span class="v">t</span> if you want to 
try to reuse a suffix of the original list in cases where the transformation 
sometimes does nothing (returns the identical element), in order to reduce 
memory footprint.  This only works if the optimized <span class="v">nrev</span> implementation is 
used, which carries a trust tag -- to use this, do <span class="v">(<a href="ACL2____INCLUDE-BOOK.html">include-book</a>
"centaur/nrev/fast" :dir :system)</span>.</p> 
 
<p>The optional <span class="v">:verbosep</span> flag can be set to <span class="v">t</span> if you want 
defprojection to print everything it's doing.  This may be useful if you run 
into any failures, or if you are simply curious about what is being 
introduced.</p> 
 
<p>The optional <span class="v">:parents</span>, <span class="v">:short</span>, and <span class="v">:long</span> keywords are as in 
<a href="ACL2____DEFXDOC.html">defxdoc</a>.  Typically you only need to specify <span class="v">:parents</span>, perhaps 
implicitly with <a href="ACL2____SET-DEFAULT-PARENTS.html">ACL2::set-default-parents</a>, and suitable documentation 
will be automatically generated for <span class="v">:short</span> and <span class="v">:long</span>.  If you don't 
like this documentation, you can supply your own <span class="v">:short</span> and/or <span class="v">:long</span> 
to override it.</p> 
 
<h3>Support for Other Events</h3> 
 
<p>Defprojection implements the same <span class="v">///</span> syntax as other macros like <a href="ACL2____DEFINE.html">define</a>.  This allows you to put related events near the definition and have 
them included in the automatic documentation.  As with define, the new 
projection function is enabled during the <span class="v">///</span> section.  Here is an 
example:</p> 
 
<pre class="code">(<a href="STD____DEFPROJECTION.html">defprojection</a> square-each (x)
  (square x)
  :guard (<a href="ACL2____INTEGER-LISTP.html">integer-listp</a> x)
  ///
  (<a href="ACL2____DEFTHM.html">defthm</a> pos-listp-of-square-each
    (pos-listp (square-each x))))</pre> 
 
<p>It is valid to use an <span class="v">///</span> section with a <span class="v">:result-type</span> theorem.  We 
arbitrarily say the <span class="v">:result-type</span> theorem comes first.</p> 
 
<p>Deprecated.  The optional <span class="v">:rest</span> keyword was a precursor to <span class="v">///</span>. 
It is still implemented, but its use is now discouraged.  If both <span class="v">:rest</span> 
and <span class="v">///</span> events are used, we arbitrarily put the <span class="v">:rest</span> events 
first.</p> 
 
<p>The optional <span class="v">:optimize</span> keyword was historically used to optionally 
optimize the projection using <span class="v">nreverse</span>.  We now use <a href="ACL2____NREV.html">ACL2::nrev</a> 
instead, and since this doesn't require a ttag, the <span class="v">:optimize</span> flag 
now does nothing.</p>
</body>
</html>
