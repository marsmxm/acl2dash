<html>
<head>
<meta charset="UTF-8">
<title>Useless-runes</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____USELESS-RUNES">Click for Useless-runes in the Full Manual</a></h3>

<p>Speed up proofs by disabling useless <a href="ACL2____RUNE.html">rune</a>s</p><p>This topic documents the <span class="v">:useless-runes</span> option for <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span>, which makes it possible to speed up repeated certification of a 
 book.</p> 
 
 <h3>Introduction</h3> 
 
 <p>For a given <a href="ACL2____EVENT.html">event</a>, the so-called ``useless'' rules are those that do 
 not contribute to the progress of any proof supporting that event.  For more 
 background see <a href="ACL2____ACCUMULATED-PERSISTENCE.html">accumulated-persistence</a>, which is typically used for 
 finding rules to <a href="ACL2____DISABLE.html">disable</a> during proofs.  The feature described in the 
 present topic provides automation for the discovery and effective disabling of 
 useless rules.</p> 
 
 <p>To use the <span class="v">:useless-runes</span> option of <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span>, first 
 certify your book — say, <span class="v">foo.lisp</span> — by supplying option 
 <span class="v">:useless-runes :write</span>.  This creates a file in the subdirectory <span class="v">.sys</span> 
 of the book's directory, creating that directory if it does not already exist. 
 This new file, <span class="v">.sys/foo@useless-runes.lsp</span>, associates names of <span class="tt"><a href="ACL2____DEFTHM.html">defthm</a></span>, <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span>, and <span class="tt"><a href="ACL2____VERIFY-GUARDS.html">verify-guards</a></span> <a href="ACL2____EVENTS.html">events</a> with sets of 
 ``useless'' <a href="ACL2____RUNE.html">rune</a>s'': rule names (``runes'') not contributing to the 
 progress of the proof.  Then, future certifications can use option 
 <span class="v">:useless-runes :read</span> — or some limited variations of <span class="v">:read</span> 
 using numeric values, as discussed below) — which, during evaluation of 
 an event, will effectively <a href="ACL2____DISABLE.html">disable</a> rules associated with that event in 
 file <span class="v">foo@useless-runes.lsp</span>.</p> 
 
 <p>Environment variable <span class="v">ACL2_USELESS_RUNES</span> can take the value 
 <span class="v">"write"</span> or <span class="v">"read"</span> to be used in place of the <span class="v">:useless-runes</span> 
 option <span class="v">:read</span> or <span class="v">:write</span> (respectively) of <span class="v">certify-book</span>. 
 <span class="v">ACL2_USELESS_RUNES</span> can also take on the numeric values permitted for the 
 <span class="v">:useless-runes</span> option of <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span>.  This is all discussed 
 below.  Note that by default, certification of the <a href="ACL2____COMMUNITY-BOOKS.html">community-books</a>, as 
 laid out in documentation topic <a href="ACL2____BOOKS-CERTIFICATION.html">books-certification</a>, is performed with 
 <span class="v">ACL2_USELESS_RUNES=-25</span>, which for each book <span class="v">foo.lisp</span> causes part of 
 the corresponding <span class="v">.sys/foo@useless-runes.lsp</span>, if it exists, to be 
 consulted (as described below).  This default behavior is only for ACL2, not 
 ACL2(r) (see <a href="COMMON-LISP____REAL.html">real</a>) or ACL2(p) (see <a href="ACL2____PARALLELISM.html">parallelism</a>).</p> 
 
 <h3>Detailed Documentation</h3> 
 
 <p>Again, the <span class="v">:useless-runes</span> option of <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span> provides a 
 way to automate discovery and, in future certifications, disabling of useless 
 runes (as described above), which can speed up proofs.  Information about 
 useless runes is communicated using a file, which we call the 
 ``@useless-runes.lsp file'' (or, sometimes, ``useless-runes file''a), whose 
 name is obtained by adding the suffix <span class="v">"@useless-runes.lsp"</span> to the book 
 name, and which is placed in the <span class="v">.sys</span> subdirectory of the book's 
 directory, after creating that subdirectory if it does not already exist.  For 
 example, if the book's file is <span class="v">foo.lisp</span> then the corresponding 
 @useless-runes.lsp file is <span class="v">.sys/foo@useless-runes.lsp</span>.</p> 
 
 <p>The following table summarizes the legal values for the option 
 <span class="v">:useless-runes</span>; further explanation follows.</p> 
 
 <pre class="code">:write   ; Write the @useless-runes.lsp file to speed up future proofs.
:read or ; Read the @useless-runes.lsp file to speed up proofs;
:read?   ;   file must exist for :read, but need not exist for :read?.
N, -N    ; N is a positive integer not exceeding 100.  Then |N|% of the rules
         ;   indicated by the @useless-runes.lsp file are to be kept disabled.
         ;   The @useless-runes.lsp file needs to exist for N but not for -N.
nil      ; Certify without reading or writing the @useless-runes.lsp file.</pre> 
 
 <p>Notice in particular that <span class="v">:useless-runes 100</span> is equivalent to 
 <span class="v">:useless-runes :read</span>, while <span class="v">:useless-runes -100</span> is equivalent to 
 <span class="v">:useless-runes :read?</span>.</p> 
 
 <p>When <span class="v">certify-book</span> is supplied with option <span class="v">:useless-runes :write</span>, 
 the result is to write out a corresponding @useless-runes.lsp file.  Each 
 top-level entry of this file that is non-trivial (see below) has the form</p> 
 
 <pre class="code">(<a href="ACL2____NAME.html">name</a>
 (frames-1 tries-1 rune-1)
 (frames-2 tries-2 rune-2)
 ...
 (frames-k tries-k rune-k)
 )</pre> 
 
 <p>where <span class="v">name</span> is the name of a <span class="tt"><a href="ACL2____DEFTHM.html">defthm</a></span>, <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span>, or <span class="tt"><a href="ACL2____VERIFY-GUARDS.html">verify-guards</a></span> event, and each tuple <span class="v">(frames-i tries-i rune-i)</span> indicates 
 the number of frames and tries for <span class="v">rune-i</span> recorded for the proofs done on 
 behalf of that event.  ACL2 claims that none of the indicated rules 
 contributed to the progress of the proof.  See <a href="ACL2____ACCUMULATED-PERSISTENCE.html">accumulated-persistence</a>, 
 but also see <a href="ACL2____ACCUMULATED-PERSISTENCE-SUBTLETIES.html">accumulated-persistence-subtleties</a> for some limitations. 
 These top-level entries are listed in order of event in the book, from top to 
 bottom.  Because of <a href="ACL2____LOCAL.html">local</a> <a href="ACL2____EVENTS.html">events</a>, the same name may appear more 
 than once; we say more about this in the ``Subtleties'' section, below.</p> 
 
 <p>Note that ``trivial'' entries are possible, where there are no tuples; in 
 that case, just <span class="v">(<a href="ACL2____NAME.html">name</a>)</span> is printed, on a single line.  Otherwise printing 
 uses the format shown above, where the first line contains a left parenthesis 
 on the left margin followed by the name, and each tuple is on a single line 
 starting in column 1 (i.e., after a single space), as is the final right 
 parenthesis.</p> 
 
 <p>When <span class="v">certify-book</span> is supplied with option <span class="v">:useless-runes :read</span> or 
 <span class="v">:useless-runes :read?</span>, then book certification takes advantage of the 
 existing @useless-runes.lsp file, if it exists.  If that file does not exist, 
 an error is caused when the option value is <span class="v">:read</span> but the option is 
 simply ignored when the option value is <span class="v">:read?</span>.</p> 
 
 <p>The value of <span class="v">:useless-runes</span> may also be a non-zero integer between 
 -100 and 100, inclusive.  The absolute value of this number is the percentage 
 of the runes associated with the current event that are to be effectively kept 
 <a href="ACL2____DISABLE.html">disable</a>d, starting with the useless rune with the highest number of 
 frames built (see <a href="ACL2____ACCUMULATED-PERSISTENCE.html">accumulated-persistence</a>).  For example, if the value 
 is 20 then 1/5 of the runes associated with the current event in the 
 @useless-runes.lsp file are to be kept disabled; so if the relevant top-level 
 form in that file is</p> 
 
  <pre class="code">(<a href="ACL2____NAME.html">name</a>
 (frames-1 tries-1 rune-1)
 (frames-2 tries-2 rune-2)
 (frames-3 tries-3 rune-3)
 (frames-4 tries-4 rune-4)
 (frames-5 tries-5 rune-5)
 (frames-6 tries-6 rune-6)
 (frames-7 tries-7 rune-7)
 )</pre> 
 
 <p>then 1/5 of the 7 runes are to be disabled, so since the first integer 
 greater than or equal to 7/5 is 2, the runes <span class="v">rune-1</span> and <span class="v">rune-2</span> will 
 be kept disabled.  Note again that the value <span class="v">100</span> for <span class="v">:useless-runes</span> 
 gives the same behavior as the value <span class="v">:read</span>, and the value <span class="v">-100</span> gives 
 the same behavior as the value <span class="v">:read?</span>.</p> 
 
 <p>The <span class="v">:useless-runes</span> option of <span class="v">certify-book</span> need not be given 
 explicitly.  Suppose that the environment variable <span class="v">ACL2_USELESS_RUNES</span> has 
 a non-empty value.  Then that value implicitly invokes the <span class="v">:useless-runes</span> 
 option as indicated by the following table, which shows how that environment 
 variable value corresponds to a value for the <span class="v">:useless-runes</span> option.</p> 
 
 <pre class="code">ACL2_USELESS_RUNES value          :useless-runes value
------------------------          --------------------

WRITE (<a href="COMMON-LISP____CASE.html">case</a> insensitive)          :write
READ (<a href="COMMON-LISP____CASE.html">case</a> insensitive)           :read
READ? (<a href="COMMON-LISP____CASE.html">case</a> insensitive)          :read?
i, ij, -i, -ij, 100, -100         corresponding integer, which cannot be 0
  (i and j are base-10 digits)</pre> 
 
 <p><b>Important</b>.  An explicitly supplied <span class="v">:useless-runes</span> value 
 normally takes priority over the value of environment variable 
 <span class="v">ACL2_USELESS_RUNES</span>.  However, the environment variable takes priority if 
 its (case insensitive) value is <span class="v">"WRITE"</span> provided <span class="v">:useless-runes
 nil</span> is not supplied explicitly.</p> 
 
 <p>If you want certification to avoid reading the book's @useless-runes.lsp 
 file even when this environment variable has a non-empty value that specifies 
 reading, call <span class="v">certify-book</span> with option <span class="v">:useless-runes nil</span>.</p> 
 
 <p>A reason for allowing integer values, rather than only <span class="v">:read</span> and 
 <span class="v">:read?</span>, is that the disabling of useless runes can cause a proof to fail. 
 Although this is probably uncommon, it can happen, for example because an 
 otherwise useless rule rewrites the hypothesis of rule R to something that can 
 not be proved by rewriting, thus blocking the use of rule R; but with the 
 useless rule disabled, R is successfully applied, sending the proof in a 
 direction that leads to failure.  This problem may disappear when using only a 
 portion of the useless rules.  See also <a href="ACL2____ACCUMULATED-PERSISTENCE-SUBTLETIES.html">accumulated-persistence-subtleties</a>.</p> 
 
 <p>Note that when using the @useless-runes.lsp file for a given event's 
 proofs, then the appropriate rules are effectively <a href="ACL2____DISABLE.html">disable</a>d not only at 
 the top level, but also whenever <a href="ACL2____HINTS.html">hints</a> are supplied.  So if an 
 <span class="v">:</span><span class="tt"><a href="ACL2____IN-THEORY.html">in-theory</a></span> hint specifies a <a href="ACL2____THEORY.html">theory</a> that includes rule R, 
 but rule R is specified for disabling for the current event by the 
 @useless-runes.lsp file, then R will be removed from the theory before 
 installing that hint.  In particular, even the hint <span class="v">:in-theory (<a href="ACL2____ENABLE.html">enable</a>
 </span>R<span class="v">)</span> will not enable R in this case.</p> 
 
 <p>Finally, we remark that the @useless-runes.lsp file is somewhat robust in 
 the following sense.  Suppose that rule R is specified in that file, but at 
 the time the @useless-runes.lsp is read, rule R has been removed from one's 
 books.  Then the inclusion of R as a useless rule will simply be ignored, 
 rather than causing an error.</p> 
 
 <h3>Subtleties</h3> 
 
 <p>The @useless-runes.lsp files do not contain any <span class="v">:</span><span class="tt"><a href="ACL2____EXECUTABLE-COUNTERPART.html">executable-counterpart</a></span> runes, because there are many places that ACL2 does 
 not track such runes for <span class="tt"><a href="ACL2____ACCUMULATED-PERSISTENCE.html">accumulated-persistence</a></span>. 
 (Details are in a comment in the ACL2 source definition of function 
 <span class="v">print-useless-runes</span>.)</p> 
 
 <p>On rare occasions, when using the <span class="v">:read</span> option or related values that 
 specify reading from an appropriate @useless-runes.lsp file, the <a href="COMMON-LISP____PACKAGE.html">package</a> of a rune's name might not be known to ACL2 at read time.  In that 
 case, that rune will be ignored.</p> 
 
 <p>Because of <a href="ACL2____LOCAL.html">local</a> <a href="ACL2____EVENTS.html">events</a>, more than one event may be 
 associated with a name in a given @useless-runes.lsp file.  When using the 
 <span class="v">:read</span> option or related values that specify reading from an appropriate 
 @useless-runes.lsp file, ACL2 considers entries for a given name from top to 
 bottom in the @useless-runes.lsp file, attempting to match them to <span class="tt"><a href="ACL2____DEFTHM.html">defthm</a></span>, <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span>, and <span class="tt"><a href="ACL2____VERIFY-GUARDS.html">verify-guards</a></span> events from top to bottom in 
 the book.</p> 
 
 <p>As suggested by discussions above, a @useless-runes.lsp file is intended 
 not to cause proof failures, even if it is older than the corresponding book 
 or even older than other books containing runes that are listed in that 
 @useless-runes.lsp file.  That said, an out-of-date @useless-runes.lsp might 
 cause proofs to fail.  In particular, imagine that there are several lemmas in 
 the corresponding book all with the same name (and thus all <a href="ACL2____LOCAL.html">local</a> to an 
 <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> event except perhaps the last), and one of those lemmas 
 other than the last is deleted from the book.  Then references to the later 
 such lemmas will be wrong in the @useless-runes.lsp file.  If you run into 
 this problem, then either regenerate the @useless-runes.lsp file (e.g., by 
 setting environment variable <span class="v">ACL2_USELESS_RUNES</span> to <span class="v">"write"</span>), or 
 give distinct names to your book's lemmas, or even consider adding a line like 
 the following to a suitable <span class="v">.acl2</span> file (see <a href="BUILD____CUSTOM-CERTIFY-BOOK-COMMANDS.html">build::custom-certify-book-commands</a>).</p> 
 
 <pre class="code">; cert-flags: ? t :useless-runes nil</pre> 
 
 <h3>Performance</h3> 
 
 <p>In ``everything'' testing of all of the <a href="ACL2____COMMUNITY-BOOKS.html">community-books</a> during 
 (not quite complete) development of this capability, we found that writing the 
 @useless-runes.lsp files (by setting the environment variable 
 <span class="v">ACL2_USELESS_RUNES</span> to <span class="v">"write"</span>) caused an 11% slowdown from the 
 normal time, but a fresh such test when reading the @useless-runes.lsp files 
 by setting the environment variable <span class="v">ACL2_USELESS_RUNES</span> to <span class="v">"25"</span> cut 
 24% from the normal time.  Books varied considerably, however.  For example, 
 after finding a specific time reduction that was particularly significant, we 
 re-certified on standalone runs (i.e., on an otherwise unloaded machine) and 
 found that the time was reduced from 17 minutes and 1.9 seconds down to 34.93 
 seconds, thus eliminating 96.6% of the time.</p>
</body>
</html>
