<html>
<head>
<meta charset="UTF-8">
<title>Note-7-0-memoize</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____NOTE-7-0-MEMOIZE">Click for Note-7-0-memoize in the Full Manual</a></h3>

<p>ACL2 Version  7.0 Notes on Changes to Memoization Implementation</p><p>See <a href="ACL2____MEMOIZE.html">memoize</a> for a user-level introduction to function 
 memoization.  Here we summarize technical changes made in Version 7.0 of ACL2 
 to the implementation of function memoization; most ACL2 users should have no 
 need to read further in this topic.  We thank Jared Davis for helpful 
 conversations.</p> 
 
 <p>The function <span class="v">memoize-init</span> now resets the table <span class="v">*memo-max-sizes*</span>, 
 which is used when creating memo tables and pons tables.  This change may be 
 irrelevant, since generally memoize-init is only called at startup.  But it 
 seemed appropriate to reset it along with all other globals involved in the 
 memoization implementation.</p> 
 
 <p>Lisp variable *print-pretty* is no longer globally set to <span class="v">t</span> by 
 certain memoization code.  Probably this change will not generally be 
 observable.</p> 
 
 <p>The utility <span class="tt"><a href="ACL2____CLEAR-MEMOIZE-STATISTICS.html">clear-memoize-statistics</a></span> now resets data for the pons 
 summary, but implementation function <span class="v">clear-memo-tables</span> no longer does 
 so (it only calls <span class="v">clear-memoize-tables</span>).</p> 
 
 <p>Avoided some recklessness in computing statistics related to ponsing 
 (specifically, replaced <span class="v">very-unsafe-incf</span> by macro <span class="v">safe-incf-pons</span>, 
 which is a wrapper for <span class="v">safe-incf</span>).</p> 
 
 <p><span class="v">Clear-memo-tables</span> no longer takes <span class="v">&amp;rest</span> arguments, since it is 
 merely a wrapper for <span class="tt"><a href="ACL2____CLEAR-MEMOIZE-TABLES.html">clear-memoize-tables</a></span>, which does not (and did 
 not) take <span class="v">&amp;rest</span> arguments.</p> 
 
 <p>For the utility <span class="v">pons-summary</span>, we no longer use <span class="v">our-syntax-nice</span>; 
 so far example, <span class="v">*print-case*</span> is not bound to <span class="v">:downcase</span>.</p> 
 
 <p>Function <span class="v">internal-real-ticks</span> (formerly <span class="v">internal-real-time</span>) now 
 uses <span class="tt"><a href="COMMON-LISP____LOGAND.html">logand</a></span> in its implementation, which should improve performance. 
 It also replaces, for non-static-hons implementations, the call 
 <span class="v">(get-internal-real-time)</span> by <span class="v">(<a href="COMMON-LISP____THE.html">the</a> mfixnum (get-internal-real-time))</span>, 
 which can also help performance.</p> 
 
 <p>More principled, consistent use is made of <span class="v">our-syntax</span> for suitable 
 printing.</p> 
 
 <p>Added ``TO DO'' comments near the top of source file 
 <span class="v">memoize-raw.lisp</span>.  Thanks to Jared Davis for suggesting some of 
 these.</p> 
 
 <p>We improved many comments in source file <span class="v">memoize-raw.lisp</span>.</p> 
 
 <p>We did some renaming, including the following (note that 
 this is probably not a complete list):</p> 
 
 <pre class="code">- number-of-arguments       -&gt; mf-len-inputs
- number-of-return-values   -&gt; mf-len-outputs
- *compute-array*           -&gt; *callers-array*
- maybe-count-pons-calls    -&gt; incf-pons-calls
- maybe-count-pons-misses   -&gt; incf-pons-misses
- print-alist               -&gt; mf-print-alist
- shorten                   -&gt; mf-shorten
- outside-p                 -&gt; outside-caller-p
- ofni                      -&gt; mf-make-symbol
- ofnum                     -&gt; mf-num-to-string
- internal-real-time        -&gt; internal-real-ticks
- dcls                      -&gt; mf-dcls
- hl-without-interrupts     -&gt; without-interrupts [which already existed]
- *ma-initial-max-symbol-to-fixnum* -&gt; *initial-max-symbol-to-fixnum*
- REPLACEMENT:
  *initial-max-memoize-fns* -&gt; *initial-2max-memoize-fns*</pre> 
 
 <p>We eliminated some dead code, including the following functions (probably 
 not a complete list): <span class="v">our-syntax-brief</span>, <span class="v">ofnm</span>, <span class="v">uses-state</span>, 
 <span class="v">global-restore-memoize</span>, <span class="v">prine-alist</span>, <span class="v">set-gc-threshold</span>, 
 <span class="v">our-gctime</span>, and <span class="v">short-symbol-name</span>, and all variants of format 
 functions with names starting with "of" except for <span class="v">ofni</span> (now 
 <span class="v">mf-make-symbol</span>) and <span class="v">ofnum</span> (now <span class="v">mf-num-to-string</span>).  Also, we 
 moved <span class="v">memoize-here-come</span> to community book 
 <span class="v">books/centaur/memoize/old/profile-raw.lsp</span>.  Regarding 
 <span class="v">our-syntax-brief</span>: there had been one call, in <span class="v">print-call-stack</span>, but 
 that call did not seem appropriate so we deleted it.</p> 
 
 <p>The variable <span class="v">*count-pons-calls*</span> was deleted.  It had been set to 
 <span class="v">t</span> and was only used during macroexpansion of <span class="v">incf-pons-calls</span> and 
 <span class="v">incf-pons-misses</span> (formerly <span class="v">maybe-count-pons-calls</span> and 
 <span class="v">maybe-count-pons-misses</span>), where that macroexpansion was done at ACL2 
 build time â€” hence user setting of <span class="v">*count-pons-calls*</span> had no 
 effect.</p> 
 
 <p>We eliminated a needless error check that prevented loading 
 <span class="v">memoize-raw.lisp</span> without <span class="v">#+hons</span>, since we don't currently ever 
 expect to try to do that.</p> 
 
 <p>Miscellaneous additional code cleanup has been done.  Here is a (probably 
 very incomplete) list.</p> 
 
 <ul> 
 
 <li>
<span class="v">Float-ticks/second-init</span> uses a default rather than duplicating the 
 default's code, and has improved treatment of errors.</li> 
 
 <li>Removed unused <span class="v">:before</span> field of <span class="v">memoize-info-ht-entry</span> 
 record.</li> 
 
 <li>The implementations of <span class="v">number-of-arguments</span> and 
 <span class="v">number-of-return-values</span> (now called <span class="v">mf-len-inputs</span> and 
 <span class="v">mf-len-outputs</span>, respectively) have been made cleaner, in particular, 
 starting with an empty <span class="v">*number-of-arguments-and-values-ht*</span>.</li> 
 
 <li>New macros such as <span class="v">ma-index</span> provide some abstraction, to give the 
 illusion that <span class="v">*memoize-call-array*</span> is two-dimensional.</li> 
 
 <li>We broke up some definitions, in particular substantially shortening 
 <span class="v">memoize-fn</span> by moving parts of it into new functions 
 <span class="v">memoize-fn-inner-body</span>, <span class="v">memoize-fn-outer-body</span>, and 
 <span class="v">memoize-fn-def</span>.  A benefit: it is easy to see the definition that is 
 actually created when memoizing, by tracing <span class="v">memoize-fn-def</span>.</li> 
 
 <li>Added raw Lisp interface function <span class="v">mf-note-arity</span> for informing 
 <span class="v">memoize-fn</span> of input and output arities.</li> 
 
 <li>
<span class="v">Coerce-index</span> asserts that an index is in range rather than treating 
 an out-of-range index as a symbol.</li> 
 
 <li>We renamed some variables to make them clearer.  In particular, it is 
 whether a variable stores time or ticks.</li> 
 
 <li>We now make complete and correct (we hope) the use of suitable <span class="v">fixnum</span> 
 and <span class="v">mfixnum</span> declarations, many of which had been missing or 
 incorrect.</li> 
 
 <li>Both <span class="tt"><a href="ACL2____MEMOIZE.html">memoize</a></span> and <span class="tt"><a href="ACL2____UNMEMOIZE.html">unmemoize</a></span> are now safe for control-c and 
 unexpected errors.</li> 
 
 <li>We no longer set <span class="v">ccl::*save-definitions*</span> or 
 <span class="v">ccl::*fasl-save-definitions*</span> to <span class="v">t</span>.  This may improve performance, 
 but it may require explicitly calling <span class="v">mf-note-arity</span>, as is now done in 
 <span class="v">books/centaur/aig/bddify.lisp</span>.  However, this removes CCL-only behavior; 
 in particular, we removed dependence on #+Clozure in 
 <span class="v">books/centaur/aig/bddify.lisp</span> for profiling <span class="v">count-branches-to</span>.</li> 
 
 <li>We use <span class="v">#+ccl</span> instead of <span class="v">#+Clozure</span>, for consistency with most of 
 the rest of ACL2.</li> 
 
 <li>We no longer set <span class="v">ccl::*save-source-locations*</span> or 
 <span class="v">ccl::*record-source-file*</span> to <span class="v">t</span>, as there is no clear advantage to 
 doing so, and in fact there is a comment near the end of source file 
 <span class="v">acl2.lisp</span> suggesting that there could be slowdown from setting (at least) 
 the first of these variables to <span class="v">t</span>.</li> 
 
 <li>We slightly modified <span class="v">internal-real-time</span> to improve its 
 performance (see comments there).</li> 
 
 <li>We fixed a performance bug in function <span class="v">addr-for</span> (parenthesis error 
 was needlessly putting us in the ``large-case'').</li> 
 
 <li>Fixed a typo: declaim of fixnum type for <span class="v">*initial-max-memoize-fns*</span> 
 had instead been for nonexistent variable 
 <span class="v">*initial-2max-memoize-fns*</span>.</li> 
 
 <li>In <span class="v">memoize-fn</span>, we removed support for <span class="v">:condition</span> to be a 
 function symbol, which was at best confused.</li> 
 
 <li>The table <span class="v">*never-memoize-ht*</span> is now populated mostly automatically, 
 by <span class="v">initialize-never-memoize-ht</span>.</li> 
 
 <li>Slight optimization: the form <span class="v">(update-attached-fn-called
 ,*attached-fn-temp*)</span>, which had been in the definition of <span class="v">memoize-fn</span> 
 but now is in <span class="v">memoize-fn-inner-body</span>, is conditioned on 
 <span class="v">,*attached-fn-temp*</span>.</li> 
 
 </ul>
</body>
</html>
