<html>
<head>
<meta charset="UTF-8">
<title>Local-incompatibility</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____LOCAL-INCOMPATIBILITY">Click for Local-incompatibility in the Full Manual</a></h3>

<p>When non-local <a href="ACL2____EVENTS.html">events</a> won't replay in isolation</p><p>Sometimes a ``<span class="tt"><a href="ACL2____LOCAL.html">local</a></span> incompatibility'' is reported while 
 attempting to embed some <a href="ACL2____EVENTS.html">events</a>, as in an <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> or <span class="tt"><a href="ACL2____INCLUDE-BOOK.html">include-book</a></span>.  This is generally due to the use of a locally defined name in 
 a non-local event or the failure to make a witnessing definition <span class="tt"><a href="ACL2____LOCAL.html">local</a></span>.  (But see the Remark at the end of this topic about a related issue 
 with guard-checking.)</p> 
 
 <p><span class="tt"><a href="ACL2____LOCAL.html">Local</a></span> incompatibilities may be detected while trying to execute the 
 strictly non-<a href="ACL2____LOCAL.html">local</a> <a href="ACL2____EVENTS.html">events</a> of an <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> or <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span> call.  For example, <span class="v">encapsulate</span> operates by first executing 
 all the <a href="ACL2____EVENTS.html">events</a> (local and non-local) with <span class="tt"><a href="ACL2____LD-SKIP-PROOFSP.html">ld-skip-proofsp</a></span> 
 <span class="v">nil</span>, to confirm that they are all admissible.  Then it attempts merely to 
 assume the non-local ones to create the desired theory, by executing the <a href="ACL2____EVENTS.html">events</a> with <span class="tt"><a href="ACL2____LD-SKIP-PROOFSP.html">ld-skip-proofsp</a></span> set to <span class="v">'include-book</span>. 
 <span class="v">Certify-book</span> does something similar, so that when <span class="tt"><a href="ACL2____INCLUDE-BOOK.html">include-book</a></span> 
 assumes the non-local events in the book, we are confident that the previously 
 successful certification has performed the necessary admissibility check.</p> 
 
 <p>How can a sequence of <a href="ACL2____EVENTS.html">events</a> admitted with <span class="tt"><a href="ACL2____LD-SKIP-PROOFSP.html">ld-skip-proofsp</a></span> 
 <span class="v">nil</span> fail when <span class="tt"><a href="ACL2____LD-SKIP-PROOFSP.html">ld-skip-proofsp</a></span> is <span class="v">'include-book</span>?  The key 
 observation is that in the latter case only the non-local <a href="ACL2____EVENTS.html">events</a> are 
 processed.  The <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> ones are skipped and so the non-local ones must 
 not depend upon them.</p> 
 
 <p>Two typical mistakes are suggested by the detection of a <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> 
 incompatibility: (1) a locally defined function or macro was used in a 
 non-<span class="tt"><a href="ACL2____LOCAL.html">local</a></span> event (and, in the case of <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span>, was not 
 included among the <a href="ACL2____SIGNATURE.html">signature</a>s) and (2) the witnessing definition of a 
 function that was included among the <a href="ACL2____SIGNATURE.html">signature</a>s of an <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> was not made <span class="tt"><a href="ACL2____LOCAL.html">local</a></span>.</p> 
 
 <p>An example of mistake (1) would be to include among your <a href="ACL2____ENCAPSULATE.html">encapsulate</a>d <a href="ACL2____EVENTS.html">events</a> both a local definition of <span class="v">f</span> and a non-local 
 theorem about <span class="v">f</span>, for example as follows.</p> 
 
 <pre class="code">(<a href="ACL2____ENCAPSULATE.html">encapsulate</a> ()
  (<a href="ACL2____LOCAL.html">local</a> (<a href="COMMON-LISP____DEFUN.html">defun</a> f (x) x))
  (<a href="COMMON-LISP____DEFUN.html">defun</a> g (x) x)

  (<a href="ACL2____DEFTHM.html">defthm</a> f-is-g (<a href="COMMON-LISP____EQUAL.html">equal</a> (f x) (<a href="ACL2____G.html">g</a> x)))
  )</pre> 
 
 <p>In this case, either the <span class="tt"><a href="ACL2____DEFTHM.html">defthm</a></span> should be made <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> or, if 
 we want to export the <span class="v">defthm</span>, then the <span class="tt"><a href="COMMON-LISP____DEFUN.html">defun</a></span> of <span class="v">f</span> should be 
 made non-local.  Similar analysis holds if the events in the <span class="v">encapsulate</span> 
 call above are instead in a book.</p> 
 
 <p>An example of mistake (2) would be to include <span class="v">((fn *) =&gt; *)</span> among your 
 <a href="ACL2____SIGNATURE.html">signature</a>s and then to write <span class="v">(<a href="COMMON-LISP____DEFUN.html">defun</a> fn (x) ...)</span> in your <a href="ACL2____EVENTS.html">events</a>, instead of <span class="v">(<a href="ACL2____LOCAL.html">local</a> (<a href="COMMON-LISP____DEFUN.html">defun</a> fn ...))</span>, as shown in the example 
 below.  In essence, this is an error because <span class="v">fn</span> is exported twice: once 
 by the signature and once by the <span class="v">defun</span>.</p> 
 
 <pre class="code">(<a href="ACL2____ENCAPSULATE.html">encapsulate</a>
  ( ((fn *) =&gt; *) )

  (<a href="COMMON-LISP____DEFUN.html">defun</a> fn (x) x)
  )</pre> 
 
 <p>One subtle aspect of <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> is that if you constrain any 
 member of a mutually recursive clique you must define the entire clique 
 locally and then you must constrain those members of it you want axiomatized 
 non-locally.</p> 
 
 <p>Errors due to <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> incompatibility should never occur in the 
 inclusion of a fully certified book.  Certification ensures against it. 
 Therefore, if <span class="tt"><a href="ACL2____INCLUDE-BOOK.html">include-book</a></span> reports an incompatibility, we claim that 
 earlier in the processing of the <span class="tt"><a href="ACL2____INCLUDE-BOOK.html">include-book</a></span> a warning was printed 
 advising you that some book was uncertified.  If this is not the case — 
 if <span class="tt"><a href="ACL2____INCLUDE-BOOK.html">include-book</a></span> reports an incompatibility and there has been no prior 
 warning about lack of certification — please report it to the ACL2 
 implementors.</p> 
 
 <p>When a <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> incompatibility is detected during the second pass of 
 an <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> or <span class="tt"><a href="ACL2____CERTIFY-BOOK.html">certify-book</a></span>, the logical <a href="ACL2____WORLD.html">world</a> is 
 restored to what it was immediately before that call was evaluated.</p> 
 
 <p>Note that for <span class="v">certify-book</span>, local incompatibility could be caused by 
 an event that is local either in the certification world (see <a href="ACL2____PORTCULLIS.html">portcullis</a>) or in the book itself.  ACL2 checks during <span class="v">certify-book</span> for 
 local incompatibility by rolling back the world — back through the first 
 portcullis command that generates a local event, or if there is none, then 
 back through the first local event in the book (with the general exception of 
 those inside an <span class="v">encapsulate</span>, but see final Remark below) — and then 
 including the book.  But all that is skipped in the absence of either kind of 
 local event.</p> 
 
 <p>Here is a subtle example of <span class="tt"><a href="ACL2____LOCAL.html">local</a></span> incompatibility.  The problem is 
 that in order for <span class="v">foo-type-prescription</span> to be admitted using the 
 specified <span class="v">:typed-term</span> <span class="v">(foo x)</span>, the conclusion <span class="v">(my-natp (foo x))</span> 
 depends on <span class="v">my-natp</span> being a <a href="ACL2____COMPOUND-RECOGNIZER.html">compound-recognizer</a>.  This is fine on 
 the first pass of the <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span>, during which lemma <span class="v">my-natp-cr</span> 
 is admitted.  But <span class="v">my-natp-cr</span> is skipped on the second pass because it is 
 marked <span class="tt"><a href="ACL2____LOCAL.html">local</a></span>, and this causes <span class="v">foo-type-prescription</span> to fail on 
 the second pass.</p> 
 
 <pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a> my-natp (x)
  (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :guard t))
  (<a href="COMMON-LISP____AND.html">and</a> (<a href="COMMON-LISP____INTEGERP.html">integerp</a> x)
       (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> 0 x)))

(<a href="COMMON-LISP____DEFUN.html">defun</a> foo (x)
  (<a href="ACL2____NFIX.html">nfix</a> x))

(<a href="ACL2____ENCAPSULATE.html">encapsulate</a>
 ()
 (<a href="ACL2____LOCAL.html">local</a> (<a href="ACL2____DEFTHM.html">defthm</a> my-natp-cr
          (<a href="COMMON-LISP____EQUAL.html">equal</a> (my-natp x)
                 (<a href="COMMON-LISP____AND.html">and</a> (<a href="COMMON-LISP____INTEGERP.html">integerp</a> x)
                      (<a href="COMMON-LISP_____C3_D3.html">&lt;=</a> 0 x)))
          :rule-classes :compound-recognizer))
 (<a href="ACL2____DEFTHM.html">defthm</a> foo-type-prescription
   (my-natp (foo x))
   :hints (("Goal" :in-theory (<a href="ACL2____ENABLE.html">enable</a> foo)))
   :rule-classes ((:type-prescription :typed-term (foo x)))))</pre> 
 
 <p><b>Remark</b>.  We conclude by remarking that for ``local incompatibility'' 
 in the case of <span class="v">certify-book</span>, the notion of ``local'' is a bit more 
 comprehensive than the name suggests, in that it can involve <a href="ACL2____GUARD.html">guard</a>-checking in the following situation.  For example, in a fresh ACL2 
 session evaluate the <a href="ACL2____COMMAND.html">command</a> <span class="v">(<a href="ACL2____SET-GUARD-CHECKING.html">set-guard-checking</a> :none)</span> followed 
 by <span class="v">(<a href="ACL2____TABLE.html">table</a> foo 0 (<a href="COMMON-LISP____CAR.html">car</a> 3))</span>.  Then any attempt to certify a book should 
 fail, since subsequent inclusion of that book would fail with a <a href="ACL2____GUARD.html">guard</a> 
 violation; that's because the <span class="v">set-guard-checking</span> call was not saved in 
 the <a href="ACL2____CERTIFICATE.html">certificate</a> file, hence was not evaluated when evaluating <span class="v">(<a href="COMMON-LISP____CAR.html">car</a>
 3)</span> while attempting to include the book.</p> 
 
 <p>The example above may be helpful while reading the following general 
 explanation of how local incompatibility incorporates the setting of 
 guard-checking.  Suppose you are evaluating <a href="ACL2____COMMAND.html">command</a>s directly in the 
 top-level read-eval-print loop.  One of those commands might be a call of 
 <span class="tt"><a href="ACL2____SET-GUARD-CHECKING.html">set-guard-checking</a></span> that weakens guard-checking from its default 
 behavior, i.e., <span class="v">(<a href="ACL2____SET-GUARD-CHECKING.html">set-guard-checking</a> VAL)</span> where <span class="v">VAL</span> is other than 
 <span class="v">t</span>, <span class="v">:nowarn</span>, or <span class="v">:all</span>.  This command does not change the logical 
 <a href="ACL2____WORLD.html">world</a>, so it will not be part of the book's <a href="ACL2____PORTCULLIS.html">portcullis</a> commands. 
 In that sense, it is like a <a href="ACL2____LOCAL.html">local</a> portcullis command.  ACL2 notices 
 this case and insists that any portcullis event evaluated with guard-checking 
 that is weaker than the default must be rolled back during the check for local 
 incompatibilities.</p>
</body>
</html>
