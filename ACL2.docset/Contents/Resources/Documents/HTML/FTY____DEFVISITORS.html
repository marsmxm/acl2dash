<html>
<head>
<meta charset="UTF-8">
<title>Defvisitors</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=FTY____DEFVISITORS">Click for Defvisitors in the Full Manual</a></h3>

<p>Generate visitor functions across types using a visitor template.</p><p>To use defvisitors, first see <a href="FTY____DEFVISITOR-TEMPLATE.html">defvisitor-template</a> and <a href="FTY____DEFVISITOR.html">defvisitor</a>.  Defvisitors automates the generation of several defvisitor forms 
that create a system of visitor functions that works on a nest of types.</p> 
 
<p>For example, suppose we have the following types:</p> 
 
<pre class="code">(<a href="FTY____DEFPROD.html">defprod</a> employee
   ((name stringp)
    (salary natp)
    (title stringp)))

(<a href="FTY____DEFLIST.html">deflist</a> employees :elt-type employee)

(<a href="FTY____DEFPROD.html">defprod</a> group
  ((lead employee)
   (members employees)
   (budget natp)
   (name stringp)
   (responsibilities string-listp)))

(<a href="FTY____DEFPROD.html">defprod</a> division
  ((<a href="SET____HEAD.html">head</a> employee)
   (operations  group)
   (engineering group)
   (sales       group)
   (service     group)
   (black-ops   group)))</pre> 
 
<p>Suppose we want to total up the salaries of all the employees in a division, 
including the division head, group leads, and group members.  A visitor 
template for this operation might look like this:</p> 
 
<pre class="code">(<a href="FTY____DEFVISITOR-TEMPLATE.html">defvisitor-template</a> salary-total ((x :object))
  :returns (total (:join (<a href="COMMON-LISP_____B2.html">+</a> total1 total)
                   :tmp-var total1
                   :initial 0)
                  natp :rule-classes :type-prescription
                  "The total salary of all employees")
  :type-fns ((employee employee-&gt;salary)))</pre> 
 
<p>Now we need visitor functions for the employees, group, and division types, so we can do:</p> 
 
<pre class="code">(<a href="FTY____DEFVISITOR.html">defvisitor</a> :type employees :template salary-total)
(<a href="FTY____DEFVISITOR.html">defvisitor</a> :type group     :template salary-total)
(<a href="FTY____DEFVISITOR.html">defvisitor</a> :type division  :template salary-total)</pre> 
 
<p>However, we can automate this more by using defvisitors instead of 
defvisitor.  This doesn't seem worthwhile to get rid of just three defvisitor 
forms, but oftentimes the type hierarchy is much more specialized than this, 
and changes frequently.  Using defvisitors can prevent the need to modify the 
code if you add a type to the hierarchy.  To invoke it:</p> 
 
<pre class="code">(<a href="FTY____DEFVISITORS.html">defvisitors</a> division-salary-total ;; optional event name
  :types (division)
  :template salary-total)</pre> 
 
<p>This searches over the field types of the <span class="v">division</span> type and creates a 
graph of the types that need to be visited, then arranges them in dependency 
order and creates the necessary defvisitor forms.</p> 
 
<p>The options for <span class="v">defvisitors</span> are somewhat more limited than for 
<span class="v">defvisitor</span>.  The available keyword arguments are as follows:</p> 
 
<ul> 
 
<li>
<span class="v">:template</span> -- the name of the visitor template to instantiate.</li> 
 
<li>
<span class="v">:types</span>, <span class="v">:dep-types</span> -- controls the top-level types to visit. 
Those listed in <span class="v">dep-types</span> are not themselves visited, but their children 
are.  Note that these are type names, NOT deftypes names as in <a href="FTY____DEFVISITOR.html">defvisitor</a>.  (For a single type, the type name and deftypes name is likely the 
same, but for a mutually-recursive clique of types, the deftypes name refers to 
the whole clique.)</li> 
 
<li>
<span class="v">:measure</span> -- measure form to use for each <span class="v">defvisitor</span> form; this is 
mostly only useful in the context of a <span class="v">defvisitor-multi</span> form.</li> 
 
<li>
<span class="v">:order-base</span> -- starting index from which the order indices assigned to 
the deftypes forms are generated; also mostly only useful in the context of a 
<span class="v">defvisitor-multi</span> form.  Defvisitors assigns a different order index to 
each defvisitor form it submits, with earlier forms having lower indices.  When 
the measure is properly formulated in terms of the order, this allows them to 
be used together in a mutual recursion.</li> 
 
<li>
<span class="v">:debug</span> -- print some information about the graph traversals.</li> 
 
</ul>
</body>
</html>
