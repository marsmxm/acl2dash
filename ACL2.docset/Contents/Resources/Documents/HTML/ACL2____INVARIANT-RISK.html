<html>
<head>
<meta charset="UTF-8">
<title>Invariant-risk</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=ACL2____INVARIANT-RISK">Click for Invariant-risk in the Full Manual</a></h3>

<p>Potential slowdown for <a href="ACL2____PROGRAM.html">program</a>-mode updates to <a href="ACL2____STOBJ.html">stobj</a>s 
 or <a href="ACL2____ARRAYS.html">arrays</a></p><p>You may see a warning like this:</p> 
 
 <pre class="code">ACL2 Warning [Invariant-risk] in MY-FUNCTION:  Invariant-risk has been
detected for a call of function MY-FUNCTION (as possibly leading to
an ill-guarded call of UPDATE-FLD); see :DOC invariant-risk.</pre> 
 
 <p>Such warnings indicate potential slowdown due to aggressive protection by 
 ACL2 against either:</p> 
 
 <ul> 
 
 <li>writing a value of the wrong type to a <a href="ACL2____STOBJ.html">stobj</a> field; or</li> 
 
 <li>performing an out-of-bounds write to an ACL2 <a href="COMMON-LISP____ARRAY.html">array</a>.</li> 
 
 </ul> 
 
 <p>Whenever a <span class="v">:</span><span class="tt"><a href="ACL2____PROGRAM.html">program</a></span>-mode function call can perhaps lead to 
 such a write, <a href="ACL2____GUARD.html">guard</a>-checking is performed by ACL2, even though the 
 normal expectation is to execute without such checks in Common Lisp; see <a href="ACL2____EVALUATION.html">evaluation</a>.  Consider the following example.</p> 
 
 <pre class="code">(<a href="ACL2____DEFSTOBJ.html">defstobj</a> st (fld :type integer :initially 0))

(<a href="COMMON-LISP____DEFUN.html">defun</a> f (n st)
  (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :stobjs st :guard (<a href="COMMON-LISP____INTEGERP.html">integerp</a> n)))
  (update-fld n st))

; This :program-mode wrapper for f fails to require (<a href="COMMON-LISP____INTEGERP.html">integerp</a> n):
(<a href="COMMON-LISP____DEFUN.html">defun</a> g (n st)
  (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :stobjs st :mode :program))
  (f n st))

; Produces an invariant-risk warning:
(<a href="ACL2____G.html">g</a> 3 st)

; Produces an invariant-risk warning and a guard violation:
(<a href="ACL2____G.html">g</a> 'a st)</pre> 
 
 <p>Each of the two calls of <span class="v">g</span> produces an <span class="v">"Invariant-risk"</span> 
 warning, and indeed <a href="ACL2____GUARD.html">guard</a>s are checked for the ensuing calls of <span class="v">f</span>, 
 causing a guard violation for the second call of <span class="v">g</span>.</p> 
 
 <p>We may say that such <span class="v">:</span><span class="tt"><a href="ACL2____PROGRAM.html">program</a></span>-mode functions have 
 invariant-risk.  Because of how the ``aggressive protection'' discussed above 
 is implemented, recursive calls of invariant-risk functions are not traced; 
 see <a href="ACL2____TRACE_42.html">trace$</a>.</p> 
 
 <p>There are two general methods for avoiding such warnings: at runtime with 
 <span class="tt"><a href="ACL2____SET-CHECK-INVARIANT-RISK.html">set-check-invariant-risk</a></span>, and at definition time with <span class="tt"><a href="ACL2____SET-REGISTER-INVARIANT-RISK.html">set-register-invariant-risk</a></span>.  We describe each briefly below.  For more 
 information follow the links just above to their respective documentation 
 topics.  For yet more detail about invariant-risk see <a href="ACL2____INVARIANT-RISK-DETAILS.html">invariant-risk-details</a>.  For tools that may help find sources of 
 invariant-risk, see <a href="ACL2____COMMUNITY-BOOK.html">community-book</a> 
 <span class="v">books/std/system/invariant-risk.lisp</span>.</p> 
 
 <h3>Controlling runtime checking for invariant-risk</h3> 
 
 <p>You can avoid seeing warnings like the one displayed above (without 
 affecting the check that is actually performed) by evaluating either one of 
 the following forms.</p> 
 
 <pre class="code">(<a href="ACL2____SET-CHECK-INVARIANT-RISK.html">set-check-invariant-risk</a> t)
(<a href="ACL2____SET-INHIBIT-WARNINGS.html">set-inhibit-warnings</a> "invariant-risk")</pre> 
 
 <p>You can also replace such warnings by errors:</p> 
 
 <pre class="code">(<a href="ACL2____SET-CHECK-INVARIANT-RISK.html">set-check-invariant-risk</a> :error)</pre> 
 
 <p>Evaluate <span class="v">(<a href="ACL2____GET-CHECK-INVARIANT-RISK.html">get-check-invariant-risk</a> state)</span> to see the current setting 
 for invariant-risk checking.  For details, including a dangerous way to remove 
 invariant-risk checking completely at runtime, see <a href="ACL2____SET-CHECK-INVARIANT-RISK.html">set-check-invariant-risk</a>.</p> 
 
 <h3>Eliminating invariant-risk checking done by specific functions</h3> 
 
 <p>On occasion you may define functions that you know avoid invariant-risk 
 danger, even though ACL2 designates those functions as having invariant-risk. 
 Rather than removing invariant-risk checking for <i>all</i> functions at 
 runtime with <span class="tt"><a href="ACL2____SET-CHECK-INVARIANT-RISK.html">set-check-invariant-risk</a></span>, it is probably much safer to 
 remove it only for the functions in a given book or <span class="tt"><a href="ACL2____ENCAPSULATE.html">encapsulate</a></span> event. 
 See <a href="ACL2____SET-REGISTER-INVARIANT-RISK.html">set-register-invariant-risk</a> for how to do that.</p>
</body>
</html>
