<html>
<head>
<meta charset="UTF-8">
<title>Sign</title>
<link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>

<h3><a href="../index.html?topic=HDWALLET____SIGN">Click for Sign in the Full Manual</a></h3>

<p>Transaction signature in the wallet.</p><div class="box"><dl> 
  <dt>Signature</dt>
<dt><pre class="code">(sign nonce-string 
      gas-price-string gas-limit-string 
      to-string value-string data-string 
      address-key-index-string stat) 
 
  → 
(mv error? signed-transaction)</pre></dt>  <dt>Arguments</dt>  <dd>
<span class="tt">nonce-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> nonce-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">gas-price-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> gas-price-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">gas-limit-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> gas-limit-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">to-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> to-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">value-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> value-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">data-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> data-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">address-key-index-string</span> — <font color="#606060">Guard <span class="v">(<a href="COMMON-LISP____STRINGP.html">stringp</a> address-key-index-string)</span>.</font>
</dd> 
  <dd>
<span class="tt">stat</span> — <font color="#606060">Guard <span class="v">(<a href="HDWALLET____STATP.html">statp</a> stat)</span>.</font>
</dd> 
<dt>Returns</dt>
<dd>
<span class="tt">error?</span> — <font color="#606060">Type <span class="v">(<a href="HDWALLET____MAYBE-COMMAND-ERROR-P.html">maybe-command-error-p</a> error?)</span>.</font>
</dd> 
<dd>
<span class="tt">signed-transaction</span> — <font color="#606060">Type <span class="v">(<a href="ACL2____BYTE-LISTP.html">byte-listp</a> signed-transaction)</span>.</font>
</dd> 
 
</dl></div> 
<p>This models the command used 
     to sign a transaction with a key in the wallet.</p><p>In Ethereum, a transaction is a 9-tuple, as formalized <a href="ETHEREUM____TRANSACTION.html">here</a>. The first six components are inputs of this function: 
     nonce, gas price, gas limit, recipient, value, and data. 
     For now, we do not support contract creation transactions; 
     thus, the sixth component is always data bytes, not initialization bytes. 
     The other three components are the signature, 
     which this function calculates.</p><p>The address key to use is specified by another input of this function. 
     This index is used to retrieve the key from the state. 
     The index must be below the number of address keys generated so far, 
     otherwise an error saying that the index is too large is returned. 
     In addition, the index must correspond to an existing key, 
     one whose derivation has not failed; 
     otherwise an error saying that the key was skipped was returned.</p><p>We construct a signed transaction with chain id 1, 
     which is for the Ethereum mainnet. 
     We return the RLP encoding of that transaction.</p><p>The guard proofs of this operation need some of the constraints 
     formalized in <span class="tt"><a href="HDWALLET____STAT-WFP.html">stat-wfp</a></span>.</p><p>Since this operation does not change the (and does not return a) state, 
     it trivially preserves the state constraints <span class="tt"><a href="HDWALLET____STAT-WFP.html">stat-wfp</a></span>.</p><p>The six components of the transaction are passed as string inputs, 
     which we parse and validate. 
     Is validation fails, specific error values are returned.</p> 
 
<h3>Definitions and Theorems</h3><p><b>Function: </b>sign</p><pre class="code">(<a href="COMMON-LISP____DEFUN.html">defun</a>
 sign
 (nonce-string gas-price-string gas-limit-string
               to-string value-string data-string
               address-key-index-string stat)
 (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :guard (<a href="COMMON-LISP____AND.html">and</a> (<a href="COMMON-LISP____STRINGP.html">stringp</a> nonce-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> gas-price-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> gas-limit-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> to-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> value-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> data-string)
                             (<a href="COMMON-LISP____STRINGP.html">stringp</a> address-key-index-string)
                             (<a href="HDWALLET____STATP.html">statp</a> stat))))
 (<a href="COMMON-LISP____DECLARE.html">declare</a> (<a href="ACL2____XARGS.html">xargs</a> :guard (<a href="HDWALLET____STAT-WFP.html">stat-wfp</a> stat)))
 (<a href="ACL2____B_A2.html">b*</a>
   (((<a href="ACL2____MV.html">mv</a> error? nonce)
     (<a href="HDWALLET____STRING-TO-WORD.html">string-to-word</a> nonce-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-NONCE.html">command-error-malformed-nonce</a> nonce-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? gas-price)
     (<a href="HDWALLET____STRING-TO-WORD.html">string-to-word</a> gas-price-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-GAS-PRICE.html">command-error-malformed-gas-price</a> gas-price-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? gas-limit)
     (<a href="HDWALLET____STRING-TO-WORD.html">string-to-word</a> gas-limit-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-GAS-LIMIT.html">command-error-malformed-gas-limit</a> gas-limit-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? to)
     (<a href="HDWALLET____STRING-TO-BYTE-LIST.html">string-to-byte-list</a> to-string))
    ((when (<a href="COMMON-LISP____OR.html">or</a> error? (<a href="COMMON-LISP____NOT.html">not</a> (<a href="COMMON-LISP_____D3.html">=</a> (<a href="ACL2____LEN.html">len</a> to) 20))))
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-TO.html">command-error-malformed-to</a> to-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? value)
     (<a href="HDWALLET____STRING-TO-WORD.html">string-to-word</a> value-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-VALUE.html">command-error-malformed-value</a> value-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? data)
     (<a href="HDWALLET____STRING-TO-BYTE-LIST.html">string-to-byte-list</a> data-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-DATA.html">command-error-malformed-data</a> data-string)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? address-key-index)
     (<a href="HDWALLET____STRING-TO-NAT.html">string-to-nat</a> address-key-index-string))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-MALFORMED-ADDRESS-KEY-INDEX.html">command-error-malformed-address-key-index</a>
              address-key-index-string)
         nil))
    ((unless (<a href="COMMON-LISP_____C3.html">&lt;</a> address-key-index
                (<a href="HDWALLET____STAT-_E3ADDRESSES.html">stat-&gt;addresses</a> stat)))
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-ADDRESS-KEY-INDEX-TOO-LARGE.html">command-error-address-key-index-too-large</a>
              address-key-index
              (<a href="HDWALLET____STAT-_E3ADDRESSES.html">stat-&gt;addresses</a> stat))
         nil))
    ((unless (<a href="BITCOIN____BIP32-PATH-IN-TREE-P.html">bip32-path-in-tree-p</a>
                  (<a href="ACL2____RCONS.html">rcons</a> address-key-index *key-path-prefix*)
                  (<a href="HDWALLET____STAT-_E3KEYS.html">stat-&gt;keys</a> stat)))
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-ADDRESS-KEY-INDEX-SKIPPED.html">command-error-address-key-index-skipped</a> address-key-index)
         nil))
    (path (<a href="ACL2____RCONS.html">rcons</a> address-key-index *key-path-prefix*))
    (key (<a href="BITCOIN____BIP32-GET-PRIV-KEY-AT-PATH.html">bip32-get-priv-key-at-path</a> (<a href="HDWALLET____STAT-_E3KEYS.html">stat-&gt;keys</a> stat)
                                     path))
    (chain-id 1)
    ((<a href="ACL2____MV.html">mv</a> error? transaction)
     (<a href="ETHEREUM____MAKE-SIGNED-TRANSACTION.html">make-signed-transaction</a> nonce gas-price
                              gas-limit to value data chain-id key))
    ((when (<a href="COMMON-LISP____EQ.html">eq</a> error? :rlp))
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-PRETRANSACTION-RLP-FAIL.html">command-error-pretransaction-rlp-fail</a>)
         nil))
    ((when (<a href="COMMON-LISP____EQ.html">eq</a> error? :ecdsa))
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-TRANSACTION-SIGN-FAIL.html">command-error-transaction-sign-fail</a>)
         nil))
    ((<a href="ACL2____MV.html">mv</a> error? transaction-rlp)
     (<a href="ETHEREUM____RLP-ENCODE-TRANSACTION.html">rlp-encode-transaction</a> transaction))
    ((when error?)
     (<a href="ACL2____MV.html">mv</a> (<a href="HDWALLET____COMMAND-ERROR-TRANSACTION-RLP-FAIL.html">command-error-transaction-rlp-fail</a>)
         nil)))
   (<a href="ACL2____MV.html">mv</a> nil transaction-rlp)))</pre> 
<p><b>Theorem: </b>maybe-command-error-p-of-sign.error?</p><pre class="code">(<a href="ACL2____DEFTHM.html">defthm</a> maybe-command-error-p-of-sign.error?
        (<a href="ACL2____B_A2.html">b*</a> (((<a href="ACL2____MV.html">mv</a> ?error? ?signed-transaction)
              (<a href="HDWALLET____SIGN.html">sign</a> nonce-string
                    gas-price-string gas-limit-string
                    to-string value-string data-string
                    address-key-index-string stat)))
            (<a href="HDWALLET____MAYBE-COMMAND-ERROR-P.html">maybe-command-error-p</a> error?))
        :rule-classes :rewrite)</pre> 
<p><b>Theorem: </b>byte-listp-of-sign.signed-transaction</p><pre class="code">(<a href="ACL2____DEFTHM.html">defthm</a> byte-listp-of-sign.signed-transaction
        (<a href="ACL2____B_A2.html">b*</a> (((<a href="ACL2____MV.html">mv</a> ?error? ?signed-transaction)
              (<a href="HDWALLET____SIGN.html">sign</a> nonce-string
                    gas-price-string gas-limit-string
                    to-string value-string data-string
                    address-key-index-string stat)))
            (<a href="ACL2____BYTE-LISTP.html">byte-listp</a> signed-transaction))
        :rule-classes :rewrite)</pre> 

</body>
</html>
